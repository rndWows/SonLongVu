<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng lương</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style cho trang in - giữ nguyên */
        .salary-slip {
            display: none;
            background: white;
            padding: 10mm;
            width: 210mm;
            height: 297mm;
            overflow: visible;
        }

        .company-name {
            padding: 5px;
        }

        .company-address {
            padding: 5px;
            border-bottom: 1px solid black;
        }

        .salary-title {
            background: yellow;
            text-align: center;
            padding: 5px;
            border: 1px solid black;
            border-top: none;
            font-weight: bold;
        }

        .payment-date {
            text-align: center;
            padding: 5px;
            border-top: none;
        }

        .info-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .info-left,
        .info-right {
            flex: 1;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table td {
            border: 1px solid black;
            padding: 5px;
        }

        .salary-details {
            border-collapse: collapse;
            width: 100%;
        }

        .salary-details th,
        .salary-details td {
            border: 1px solid black;
            padding: 5px;
        }

        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            text-align: center;
        }

        .signature-box {
            flex: 1;
            margin: 0 10px;
        }

        @media print {
            .salary-slip {
                position: absolute;
                top: 0;
                left: 0;
                visibility: visible;
                overflow: hidden;
                width: 210mm;
                height: 297mm;
            }

            .salary-slip,
            .salary-slip * {
                visibility: visible;
            }

            .no-print {
                display: none;
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 no-print">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Bảng Lương Nhân Viên</h1>
                <button onclick="exportTableToExcel()" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-file-excel"></i>
                    Xuất Excel
                </button>
            </div>

            <div class="overflow-x-auto custom-scrollbar">
                <table id="dataTable" class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ngày tháng</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Họ và tên</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Chức vụ</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Lương cơ bản</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Hiệu quả công việc</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Điện thoại</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Đồng phục</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Nhà ở</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Khác</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tổng thu nhập</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tiền cơm tăng ca/hỗ trợ khác</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Ngày công chuẩn</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Ngày công đi làm thực tế</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Số giờ tăng ca ngày thường</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Số giờ làm chủ nhật</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Số giờ làm ngày lễ</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tổng tiền tăng ca</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tổng thu nhập thực tế</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">BHXH (8%) CN</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">BHYT (1,5%) CN</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">BHTN (1%) CN</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tổng BHXH (10,5%) CN</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Thuế TNCN</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tạm ứng</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Khoản giảm trừ khác</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Tổng các khoản trừ</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Thưởng</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700 bg-blue-50">Thực lĩnh</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">In</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm vào đây bởi JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Giữ nguyên phần template phiếu lương -->
    <div id="salarySlip" class="salary-slip">
        <!-- Giữ nguyên nội dung cũ -->
        <div class="company-header">
            <div class="company-name">CÔNG TY TNHH SẢN XUẤT SƠN LONG VŨ</div>
            <div class="company-address">222 Nguyễn Trường Tộ, Phường Tân Thành, Quận Tân Phú, TPHCM</div>
        </div>
        <div class="salary-title">Phiếu Thanh Toán Tiền Lương</div>
        <div class="payment-date" id="paymentDate"></div>

        <div style="display: flex; margin-top: 10px;">
            <div style="flex: 1; margin-right: 10px;">
                <table class="info-table">
                    <tr>
                        <td style="width: 120px;">Mã Nhân Viên</td>
                        <td id="employeeId"></td>
                    </tr>
                    <tr>
                        <td>Họ Và Tên</td>
                        <td id="employeeName"></td>
                    </tr>
                    <tr>
                        <td>Chức vụ</td>
                        <td id="employeePosition"></td>
                    </tr>
                </table>
            </div>
            <div style="flex: 1; margin-left: 10px;">
                <table class="info-table">
                    <tr>
                        <td>Lương đóng BHBB</td>
                        <td id="baseSalary" style="text-align: right"></td>
                    </tr>
                    <tr>
                        <td>Ngày công đi làm</td>
                        <td id="workDays" style="text-align: right"></td>
                    </tr>
                    <tr>
                        <td>Ngày công chuẩn</td>
                        <td id="standardDays" style="text-align: right"></td>
                    </tr>
                </table>
            </div>
        </div>

        <div style="display: flex; margin-top: 10px;">
            <div style="flex: 1; margin-right: 5px;">
                <table class="salary-details">
                    <tr>
                        <th style="width: 40px;">STT</th>
                        <th>Các Khoản Thu Nhập</th>
                        <th style="width: 120px;">Số Tiền</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>Mức lương</td>
                        <td style="text-align: right" id="salary"></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Chi phí hỗ trợ ĐT NN/TV</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Trách nhiệm</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Độc hại</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Hiệu quả công việc</td>
                        <td style="text-align: right" id="performance"></td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>Chuyên cần</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Khác</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>Điện Thoại</td>
                        <td style="text-align: right" id="phone"></td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>Đồng phục</td>
                        <td style="text-align: right" id="uniform"></td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td>Nhà ở</td>
                        <td style="text-align: right" id="housing"></td>
                    </tr>
                    <tr>
                        <td>11</td>
                        <td>Tiền hỗ trợ khác</td>
                        <td style="text-align: right" id="otherSupport"></td>
                    </tr>
                    <tr>
                        <td>12</td>
                        <td>Tiền cơm</td>
                        <td style="text-align: right" id="meals"></td>
                    </tr>
                    <tr>
                        <td>13</td>
                        <td>Tiền tăng ca</td>
                        <td style="text-align: right" id="overtime"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; font-weight: bold">Tổng Cộng</td>
                        <td style="text-align: right; font-weight: bold" id="totalIncome"></td>
                    </tr>
                </table>
            </div>

            <div style="flex: 1; margin-left: 5px;">
                <table class="salary-details">
                    <tr>
                        <th style="width: 40px;">STT</th>
                        <th>Các Khoản Trừ Vào Lương</th>
                        <th style="width: 120px;">Số Tiền</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>Bảo Hiểm Bắt Buộc</td>
                        <td style="text-align: right" id="insurance"></td>
                    </tr>
                    <tr>
                        <td>1.1</td>
                        <td>Bảo hiểm xã hội (8%)</td>
                        <td style="text-align: right" id="social"></td>
                    </tr>
                    <tr>
                        <td>1.2</td>
                        <td>Bảo hiểm y tế (1.5%)</td>
                        <td style="text-align: right" id="health"></td>
                    </tr>
                    <tr>
                        <td>1.3</td>
                        <td>Bảo hiểm thất nghiệp (1%)</td>
                        <td style="text-align: right" id="unemployment"></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Thuế Thu Nhập Cá Nhân</td>
                        <td style="text-align: right" id="tax"></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Tạm Ứng</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Khác</td>
                        <td style="text-align: right">-</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; font-weight: bold">Tổng Cộng</td>
                        <td style="text-align: right; font-weight: bold" id="totalDeductions"></td>
                    </tr>
                </table>
            </div>
        </div>

        <div style="margin-top: 10px;">
            <table class="info-table">
                <tr>
                    <td colspan="2" style="text-align: center; font-weight: bold">Tổng Số Tiền Lương Thực Nhận</td>
                    <td style="width: 150px; text-align: right; font-weight: bold" id="finalSalary"></td>
                </tr>
            </table>
        </div>

        <div class="signatures">
            <div class="signature-box">
                <p>Người lập phiếu</p>
            </div>
            <div class="signature-box">
                <p>Người nhận tiền</p>
            </div>
            <div class="signature-box">
                <p>Thủ Quỹ</p>
            </div>
            <div class="signature-box">
                <p>Kế Toán Trưởng</p>
            </div>
            <div class="signature-box">
                <p>Giám Đốc</p>
            </div>
        </div>
    </div>

    <script>
        const APP_ID = 'adec5120-c6cb-45d5-a6d3-18ee7a2bc1dc';
        const API_KEY = 'V2-fx0Jb-XsNQV-UlFiW-4mQBj-5c63c-wZaIk-D0LoM-o1Y74';
        const SHEET_NAME_2 = 'BLUONG';
        let allData = [];
        let filteredData = [];

        function getIDBLFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('idbl');
        }

        function updateURLWithIDBL(idbl) {
            const newURL = `${window.location.protocol}//${window.location.host}${window.location.pathname}?idbl=${idbl}`;
            window.history.pushState({ path: newURL }, '', newURL);
        }

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://www.appsheet.com/api/v2/apps/${APP_ID}/tables/${tableName}/Action`;
            return fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            }).then(response => response.json());
        }

        function loadData() {
            const idbl = getIDBLFromURL();
            if (!idbl) {
                console.error('Không có IDBL trong URL');
                return;
            }

            apiRequest('BLUONG', 'Find', {
                Rows: [],
                Properties: { Selector: `Filter(BLUONG, [IDBL] = '${idbl}')` }
            })
                .then(banHangData => {
                    if (banHangData.length === 0) {
                        console.error('Không tìm thấy dữ liệu trong BLUONG');
                    } else {
                        allData = banHangData;
                        filteredData = allData;

                        apiRequest('BLUONGDETAIL', 'Find', {
                            Rows: [],
                            Properties: { Selector: `Filter(BLUONGDETAIL, [IDBL] = '${idbl}')` }
                        })
                            .then(chiTietData => {
                                populateTable(chiTietData);
                                console.log('Data loaded successfully from BLUONGDETAIL:', chiTietData);
                            })
                            .catch(error => {
                                console.error('Error loading data from BLUONGDETAIL:', error);
                            });
                    }
                    console.log('Data loaded successfully from BLUONG:', allData);
                })
                .catch(error => {
                    console.error('Error loading data from BLUONG:', error);
                });
        }

        function formatNumber(value) {
            return parseFloat(value).toFixed(2);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function populateTable(data) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors duration-150';

                // Add cells with Tailwind classes for styling
                const cells = [
                    { text: item['NGÀY THÁNG'], align: 'left' },
                    { text: item['HỌ VÀ TÊN'], align: 'left' },
                    { text: item['CHỨC VỤ'], align: 'left' },
                    { text: formatCurrency(item['Lương cơ bản']), align: 'right' },
                    { text: formatCurrency(item['Hiệu quả công việc']), align: 'right' },
                    { text: formatCurrency(item['Điện thoại']), align: 'right' },
                    { text: formatCurrency(item['Đồng phục']), align: 'right' },
                    { text: formatCurrency(item['Nhà ở']), align: 'right' },
                    { text: formatCurrency(item['Khác']), align: 'right' },
                    { text: formatCurrency(item['Tổng thu nhập']), align: 'right' },
                    { text: formatCurrency(item['Tiền cơm tăng ca/ hỗ trợ khác']), align: 'right' },
                    { text: item['Ngày công chuẩn'], align: 'right' },
                    { text: item['Ngày công đi làm thực tế'], align: 'right' },
                    { text: formatNumber(item['Số giờ tăng ca ngày thường']), align: 'right' },
                    { text: formatNumber(item['Số giờ làm chủ nhật']), align: 'right' },
                    { text: formatNumber(item['Số giờ làm ngày lễ']), align: 'right' },
                    { text: formatCurrency(item['Tổng tiền tăng ca']), align: 'right' },
                    { text: formatCurrency(item['Tổng thu nhập thực tế']), align: 'right' },
                    { text: formatCurrency(item['BHXH (8%) CN']), align: 'right' },
                    { text: formatCurrency(item['BHYT (1,5%) CN']), align: 'right' },
                    { text: formatCurrency(item['BHTN (1%) CN']), align: 'right' },
                    { text: formatCurrency(item['Tổng BHXH (10,5%) CN']), align: 'right' },
                    { text: formatCurrency(item['Thuế TNCN']), align: 'right' },
                    { text: formatCurrency(item['Tạm ứng']), align: 'right' },
                    { text: formatCurrency(item['Khoản giảm trừ khác']), align: 'right' },
                    { text: formatCurrency(item['Tổng các khoản  trừ']), align: 'right' },
                    { text: formatCurrency(item['Thưởng']), align: 'right' },
                    { text: formatCurrency(item['Thực lĩnh']), align: 'right', highlight: true }
                ];

                cells.forEach(({ text, align, highlight }) => {
                    const cell = row.insertCell();
                    cell.className = `px-4 py-2 text-sm text-gray-700 ${align === 'right' ? 'text-right' : ''} 
                        ${highlight ? 'font-semibold text-blue-600 bg-blue-50' : ''}`;
                    cell.textContent = text;
                });

                // Add print button
                const printCell = row.insertCell();
                printCell.className = 'px-4 py-2 text-center';
                const printBtn = document.createElement('button');
                printBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition duration-200 text-sm flex items-center gap-1 mx-auto';
                printBtn.innerHTML = '<i class="fas fa-print"></i> In';
                printBtn.onclick = () => printSalarySlip(item);
                printCell.appendChild(printBtn);
            });
        }

        function printSalarySlip(data) {
            // Giữ nguyên logic in phiếu lương
            document.getElementById('paymentDate').textContent = data['NGÀY THÁNG'] || '';
            document.getElementById('employeeId').textContent = data['MÃ NHÂN VIÊN'] || '';
            document.getElementById('employeeName').textContent = data['HỌ VÀ TÊN'] || '';
            document.getElementById('employeePosition').textContent = data['CHỨC VỤ'] || '';
            document.getElementById('baseSalary').textContent = formatCurrency(data['Lương BHXH'] || 0);
            document.getElementById('workDays').textContent = data['Ngày công đi làm thực tế'] || '';
            document.getElementById('standardDays').textContent = data['Ngày công chuẩn'] || '';
            document.getElementById('salary').textContent = formatCurrency(data['Lương cơ bản'] || 0);
            document.getElementById('performance').textContent = formatCurrency(data['Hiệu quả công việc'] || 0);
            document.getElementById('phone').textContent = formatCurrency(data['Điện thoại'] || 0);
            document.getElementById('uniform').textContent = formatCurrency(data['Đồng phục'] || 0);
            document.getElementById('housing').textContent = formatCurrency(data['Nhà ở'] || 0);
            document.getElementById('otherSupport').textContent = formatCurrency(data['Tiền hỗ trợ khác'] || 0);
            document.getElementById('meals').textContent = formatCurrency(data['Tiền cơm'] || 0);
            document.getElementById('overtime').textContent = formatCurrency(data['Tổng tiền tăng ca'] || 0);
            document.getElementById('totalIncome').textContent = formatCurrency(data['Tổng thu nhập thực tế'] || 0);
            document.getElementById('insurance').textContent = formatCurrency(data['Tổng BHXH (10,5%) CN'] || 0);
            document.getElementById('social').textContent = formatCurrency(data['BHXH (8%) CN'] || 0);
            document.getElementById('health').textContent = formatCurrency(data['BHYT (1,5%) CN'] || 0);
            document.getElementById('unemployment').textContent = formatCurrency(data['BHTN (1%) CN'] || 0);
            document.getElementById('tax').textContent = formatCurrency(data['Thuế TNCN'] || 0);
            document.getElementById('totalDeductions').textContent = formatCurrency(data['Tổng các khoản  trừ'] || 0);
            document.getElementById('finalSalary').textContent = formatCurrency(data['Thực lĩnh'] || 0);

            document.getElementById('salarySlip').style.display = 'block';
            window.print();
            document.getElementById('salarySlip').style.display = 'none';
        }

        function exportTableToExcel() {
            var table = document.getElementById("dataTable");
            var workbook = XLSX.utils.table_to_book(table, { sheet: "Bảng lương" });
            XLSX.writeFile(workbook, 'BangLuong.xlsx');
        }

        window.onload = loadData;
        // Thêm hàm loading indicator
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50 z-50';
            loadingDiv.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-lg flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <div class="text-gray-700">Đang tải dữ liệu...</div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Thêm thông báo lỗi/thành công
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Cải thiện hàm loadData với loading và thông báo
        async function loadData() {
            try {
                showLoading();
                const idbl = getIDBLFromURL();
                if (!idbl) {
                    throw new Error('Không có IDBL trong URL');
                }

                const banHangData = await apiRequest('BLUONG', 'Find', {
                    Rows: [],
                    Properties: { Selector: `Filter(BLUONG, [IDBL] = '${idbl}')` }
                });

                if (banHangData.length === 0) {
                    throw new Error('Không tìm thấy dữ liệu trong BLUONG');
                }

                allData = banHangData;
                filteredData = allData;

                const chiTietData = await apiRequest('BLUONGDETAIL', 'Find', {
                    Rows: [],
                    Properties: { Selector: `Filter(BLUONGDETAIL, [IDBL] = '${idbl}')` }
                });

                populateTable(chiTietData);
                showNotification('Tải dữ liệu thành công!');
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Cải thiện hàm xuất Excel
        async function exportTableToExcel() {
            try {
                showLoading();
                const table = document.getElementById("dataTable");
                const workbook = XLSX.utils.table_to_book(table, { 
                    sheet: "Bảng lương",
                    dateNF: 'dd/mm/yyyy',
                    cellStyles: true
                });
                
                // Tùy chỉnh độ rộng cột
                const worksheet = workbook.Sheets["Bảng lương"];
                const cols = worksheet['!cols'] || [];
                cols[0] = { wch: 15 }; // Ngày tháng
                cols[1] = { wch: 25 }; // Họ và tên
                cols[2] = { wch: 15 }; // Chức vụ
                // Thêm độ rộng cho các cột khác...
                worksheet['!cols'] = cols;

                XLSX.writeFile(workbook, `BangLuong_${new Date().toISOString().slice(0,10)}.xlsx`);
                showNotification('Xuất Excel thành công!');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('Lỗi khi xuất Excel!', 'error');
            } finally {
                hideLoading();
            }
        }

        // Thêm tính năng tìm kiếm và lọc
        function setupSearch() {
            const searchInput = document.createElement('input');
            searchInput.className = 'w-64 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4';
            searchInput.placeholder = 'Tìm kiếm nhân viên...';
            document.querySelector('.container').insertBefore(searchInput, document.getElementById('dataTable'));

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const tbody = document.getElementById('dataTable').querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Khởi tạo các tính năng khi trang load
        window.onload = () => {
            loadData();
            setupSearch();
        };
    </script>
</body>
</html>
